<template>

  <div class="help-content">
    <div class="container-fluid">
      <div class="row pl-2">

        <div class="nav nav-pills col-1"
          role="tablist"
          aria-orientation="vertical">
          <a href="help#about"
            class="nav-link">
            <span class="fa fa-fw fa-question-circle">
            </span>&nbsp;
            About
          </a>
          <a href="help#links"
            class="nav-link">
            <span class="fa fa-fw fa-link">
            </span>&nbsp;
            Links
          </a>
          <a href="help#search"
            class="nav-link">
            <span class="fa fa-fw fa-search">
            </span>&nbsp;
            Search Bar
          </a>
          <a href="help#stringSearch"
            class="nav-link nested">
            String
          </a>
          <a href="help#ipSearch"
            class="nav-link nested">
            IP
          </a>
          <a href="help#numericSearch"
            class="nav-link nested">
            Numeric
          </a>
          <a href="help#dateSearch"
            class="nav-link nested">
            Date
          </a>
          <a href="help#fieldExistsSearch"
            class="nav-link nested">
            Field Exists
          </a>
          <a href="help#examples"
            class="nav-link nested">
            Examples
          </a>
          <a href="help#sessions"
            class="nav-link">
            <span class="fa fa-fw fa-exchange">
            </span>&nbsp;
            Sessions
          </a>
          <a href="help#spiview"
            class="nav-link">
            <span class="fa fa-fw fa-eyedropper">
            </span>&nbsp;
            SPI View
          </a>
          <a href="help#spigraph"
            class="nav-link">
            <span class="fa fa-fw fa-bar-chart">
            </span>&nbsp;
            SPI Graph
          </a>
          <a href="help#connections"
            class="nav-link">
            <span class="fa fa-fw fa-sitemap">
            </span>&nbsp;
            Connections
          </a>
          <a href="help#files"
            class="nav-link">
            <span class="fa fa-fw fa-files-o">
            </span>&nbsp;
            Files
          </a>
          <a href="help#stats"
            class="nav-link">
            <span class="fa fa-fw fa-line-chart">
            </span>&nbsp;
            Stats
          </a>
          <a href="help#history"
            class="nav-link">
            <span class="fa fa-fw fa-history">
            </span>&nbsp;
            History
          </a>
          <a href="help#settings"
            class="nav-link">
            <span class="fa fa-fw fa-cog">
            </span>&nbsp;
            Settings
          </a>
          <a href="help#users"
            v-has-permission="'createEnabled'"
            class="nav-link">
            <span class="fa fa-fw fa-users">
            </span>&nbsp;
            Users
          </a>
          <a href="help#fields"
            class="nav-link">
            <span class="fa fa-fw fa-list">
            </span>&nbsp;
            Fields
          </a>
        </div>

        <div class="col mt-5">

          <h3 id="about">
            <span class="fa fa-question-circle"></span>&nbsp;
            About
          </h3>
          <p><strong>
            Moloch is a large scale, open source, full packet capturing, indexing,
            and database system.
          </strong></p>
          <p>
            Moloch is not meant to replace Intrusion Detection Systems (IDS).
            Moloch augments your current security infrastructure by storing and
            indexing network traffic in standard PCAP format, while also providing
            fast indexed access. Moloch is built with an intuitive UI/UX which
            reduces the analysis time of suspected incidents.
          </p>

          <hr>

          <h3 id="links">
            <span class="fa fa-fw fa-link"></span>&nbsp;
            Links
          </h3>
          <div class="row">
            <div class="col-sm-12">
              <a class="btn btn-link" href="http://molo.ch">Home Page</a> |
              <a class="btn btn-link" href="http://github.com/aol/moloch/wiki/FAQ">FAQ</a> |
              <a class="btn btn-link" href="http://github.com/aol/moloch/wiki">Wiki</a> |
              <a class="btn btn-link" href="http://github.com/aol/moloch">GitHub</a> |
              <a class="btn btn-link" href="https://slackinvite.molo.ch/">Request Slack Invite</a>
            </div>
          </div>

          <hr>

          <h3 id="search">
            <span class="fa fa-search"></span>&nbsp;
            Search Bar
          </h3>
          <p>
            Most Moloch tabs have a search bar on the top of the page.
            Moloch uses a very simple query language for building expressions. It
            supports grouping using parenthesis as well as logical AND and OR statements using &amp;&amp; and
            || respectively. Fields can be accessed directly using the field names
            and operators described in the <a href="help#fields">table below</a>.
            Most fields also support a shorthand OR query using square brackets
            using CSV rules to list possible values (field==[item1,item2,item3]).
          </p>
          <p>
            All queries are bounded by a start and stop time. The bounded start and stop times can be
            set either by selecting a choice from a quick relative drop down or by entering exact time sections.
            Since every session has a first packet, last packet, and database timestamp, Moloch offers
            a choice on how to select the sessions:
          </p>
          <dl class="dl-horizontal small">
            <dt>First Packet</dt>
            <dd>The timestamp of the first packet received for the session.</dd>
            <dt>Last Packet</dt>
            <dd>The timestamp of the last packet received for the session.</dd>
            <dt>Bounded</dt>
            <dd>Both the first and last packet timestamps for the session must be inside the time window.</dd>
            <dt>Session Overlaps</dt>
            <dd>The timestamp of the first packet must be before the end of the time window AND the timestamp of the last packet must be after the start of the time window.</dd>
            <dt>Database</dt>
            <dd>The timestamp the session was written to the database.  This can be up to several minutes AFTER the last packet was received.</dd>
          </dl>

          <br>

          <h4 id="stringSearch">String Search</h4>
          <p>
            In Moloch string fields are special since they can be searched in several different
            ways. When fields are indexed, their case may or may not be normalized,
            which is documented in the <a href="help#fields">fields table below</a>.
            The types of string searches are:
          </p>
          <dl class="dl-horizontal small">
            <dt>Wildcard</dt>
            <dd>
              If a <code>*</code> appears in a expression, it is assumed a wildcard
              match is being used. Supported wildcards are <code>*</code>, which
              matches any character sequence (including the empty one), and
              <code>?</code>, which matches any single character. The wildcard query
              is run against the full text strings, after case normalization if
              enabled for the field. For example
              <code>http.uri == "www.f*k.com"</code> will capture an http.uri string
              which contains either www.fork.com or www.frack.com.
            </dd>
            <dt>Regex</dt>
            <dd>
              A regex query must be surrounded by forward slashes and will always be
              anchored. This means you will almost always want to include a leading
              and trailing <code>.*.</code> within your regex query. The regex query
              is run against the full text strings, after case normalization (if enabled) for the field.
              For example <code>http.uri == /.*www\.f.*k\.com.*/.</code> It uses the
              Lucene regex implementation which doesn't support most PCRE features.
            </dd>
            <dt>Lists</dt>
            <dd>
              In Moloch, lists are used as a short hand method for doing multiple OR queries. For example
              <code>protocols == [http, ssh]</code>. This query will search for any sessions containing either http OR ssh.
              Note: Currently a list containing wildcard or regex strings will be processed as normal strings instead
              of wildcards and regexes.
            </dd>
          </dl>

          <br>

          <h4 id="ipSearch">IP Search</h4>
          <p>
            IP searching is very flexible and can be performed using the full ip
            address, a partial ip address, CIDR representation. For fields
            that include a port number, it is possible to follow any of the ip
            representations with a colon (ip4) or dot (ip6) and then the port number to further refine a query. Ports are also
            first class searchable and may be searched for directly. For example:
            <code>ip == 1.2.3/24:80</code>. This query will search for all sessions which contain an IP address within the 1.2.3/24 CIDR range as well as utilizing port 80 during the session.
            An IP search can also be done with list of IPs which may be in mixed representations: <code>ip == [1.2.3.4, 1.3/16]</code>
          </p>

          <br>

          <h4 id="numericSearch">Numeric Search</h4>
          <p>
            Numeric fields support simple range operators besides the default equals
            and not equals query types. For example - show events with bytes transferred being less then 10000: <code>bytes &lt;= 10000</code>.
            Numeric fields also support lists for a simple OR query. For example: <code>port == [80,443,23]</code>
          </p>

          <br>

          <h4 id="dateSearch">Date Search</h4>
          <p>
            Date fields support simple range operators besides the default equals
            and not equals. For example: <code>starttime == "2004/07/31 05:33:41"</code>.
            They also support lists for a simple OR query. For example:
            <code>stoptime == ["2004/07/31 05:33:41", "2004/07/31 06:33:41"]</code>.
            Finally, relative dates and optional snapping are supported using the
            Splunk syntax:
          </p>

          <ul class="small">
            <li>
              Begin the string with a plus (+) or minus (-) to indicate the offset from
              the current time.
            </li>
            <li>
              Define the time amount with a number and a unit.
              The supported time units are:
              <ul>
                <li>
                  <strong>second:</strong> s, sec, secs, second, seconds
                </li>
                <li>
                  <strong>minute:</strong> m, min, minute, minutes
                </li>
                <li>
                  <strong>hour:</strong> h, hr, hrs, hour, hours
                </li>
                <li>
                  <strong>day:</strong> d, day, days
                </li>
                <li>
                  <strong>week:</strong> w, week, weeks
                </li>
                <li>
                  <strong>month:</strong> mon, month, months
                </li>
                <li>
                  <strong>quarter:</strong> q, qtr, qtrs, quarter, quarters
                </li>
                <li>
                  <strong>year:</strong> y, yr, yrs, year, years
                </li>
              </ul>
            </li>
            <li>
              Optionally, specify a "snap to" time unit that indicates the nearest
              or latest time to which the time amount rounds down. Separate the time
              amount from the "snap to" time unit with an "@" character.
            </li>
          </ul>

          <br>

          <h4 id="fieldExistsSearch">Field Exists Search</h4>
          <p>
            It is possible to check if a field has been set or not in the session by
            using the special comparison value of <code>field == EXISTS!</code> OR negated: <code>field != EXISTS!</code>.
            For example, to verify that a certificate doesn't have an issuer common name, but does
            have a issuer organizational name, the follow query could be used:
            <code>cert.issuer.cn != EXISTS! &amp;&amp; cert.issuer.on == EXISTS!</code>
          </p>

          <hr>

          <h4 id="examples">Examples</h4>

          <p>
            Find all the sessions involving Russia (RU) or China (CN) that are
            using port 80 and also a hostname which contains "com":
            <pre>
              (country == RU || country == CN) &amp;&amp; port == 80 &amp;&amp; host == *com
            </pre>
          </p>
          <p>
            Find all the sessions of type "text/plain", involving Canada (CA), and
            containing less than 20 packets:
            <pre>
              <code>tags == "http:content:text/plain" &amp;&amp; country == CA &amp;&amp; packets &lt; 20</code>
            </pre>
          </p>

          <hr>

          <h3 id="sessions">
            <span class="fa fa-fw fa-exchange"></span>&nbsp;
            Sessions
          </h3>
          <p>
            The sessions tab within Moloch is where an analyst will find the bulk of details regarding
            the sessions which are being investigated. From top to bottom the sessions tab contains as follows:
          </p>
          <p>
            The magnifying glass in the top left corner indicates the search bar. Enter your query string here and then hit ENTER or click the "Search" button to run your query.
            While typing fieldnames into the query bar predicative typing will overlay with potential fieldname choices based on what has been typed so far.
          </p>
          <p>
            The eyeball icon will allow an Analyst to either overlay a save "View" onto their current query, or save the current query as a "View" for easy recall in the future.
            Views should be used for often used search queries that an Analyst regularly finds themselves running.
          </p>
          <p>
            The purple "Down" arrow contains a few options. The first is to export a PCAP of the required sessions data. Second, the data within the viewer may also be exported as a CSV for further review and manipulation.
            Third, Tags may be added to the sessions which have been detected by the Analyst's query. Theses events can then later be recalled by using the <code>tags == "blah"</code> statements.
            The fourth option is used to send the selected data to another system for further analysis. Each of these options may be applied to only sessions which have been opened (by clicking the sessions + box),
            any items visible (on the current page), or all items which have matched the query string.
          </p>
          <p>
            The next line on the sessions tab contains the time bounding selections. The first element sets relative timing (such as last hour, last day, etc).
            The Start box allows a start time/date to be selected. The End box allows an end time/date to be selected.
            The bounding box is used to select where time bounding is applied (last packet, bounded, Session Overlaps, Database)
          </p>
          <p>
            The next section contains a visualisation of the query's output. This quick glance visualization may be viewed by Session count, Packets count, or Databytes count.
            Clicking and dragging over bars within the chart will drill into the selected time frame so only it is selected. Additionally, a user can click the "+" or "-" magnifying glasses to quickly zoom out or zoom in the time window being observed.
          </p>
          <p>
          The pagination header and records per page selected box is immediately below the quick visualisation and are self descriptive.
          </p>
          <p>
            Now we arrive at the meat of the Sessions tab... Our Session Data! Before we drill into what can be observed within the sessions data, please take note of the purple box which contains 9 white squares. By clicking this box an Analyst may select
            any column that they wish to observed without opening a session fully. Predictive typing is also applied within this box. Example: An analyst is only investigating suspicious IRC sessions via the Analyst's search query. Instead of drilling into each
            session that Analyst has decided to only show the Start Time, End Time, Src IP, Src Port, Dst IP, Dst Pot, IRC Channel, and IRC Nickname. This column selection tool allows for an Analyst to readily view the information which is important to them,
            configurable per investigation.
          </p>
          <p>
            <!-- TODO: describe right click interactions for column headers -->
          </p>
          <p>
            Viewing the sessions data of a specific network session is as easy as clicking the "Plus" sign next to a session. Upon clicking the + the session drawer will expand giving further context to the session.
            All packet data which was parsed will now be displayed. This includes everything fro the USer making the connection to the TCP Flags observed during the session.
            If the sessions is HTTP based further data such as Method, User Agents, and Response Headers are readily observable. The extracted Request and Response packet text will also be readily available in either a natural, ascii, utf8, or hex format.
            Furthermore, an analyst can uncompress response data as well as image files which were transferred during the session (be cautious with this option click if investigating sensitive images). Other files (such as mp3s, swf, or js files) may be clicked so that
            they may be downloaded and analyzed when necessary.
          </p>
          <hr>

          <h3 id="spiview">
            <span class="fa fa-fw fa-eyedropper"></span>&nbsp;
            SPI View
          </h3>
          <p>
            The SPI (Session Profile Information) View is used to dive into specific metrics of a session which and analyst wish to further focus in on. Instead of manually writing a query
            an analyst can use right click actions within the SPI View which will all the Analyst to add the specific item as an AND or AND NOT item to their query. This tab also allows an
            analyst a quick view into counts of each item that the user is interested in. As an example, if a analyst wanted to see all BASIC authorization headers that have been recorded
            over the current time Window and analyst could open the http drawer and click to enable the http.authorization field. The analyst could then update their search query to either
            include a specific authorization string which has been observed, or use a wild card to see all of a certain type of authorization header (Basic *, BEARER *, etc). Additionally,
            the SPI View allows an analyst a quick view of observed IP addresses within the time window, http response codes, IRC NICKs/Channels, and much, much more.
          </p>

          <hr>

          <h3 id="spigraph">
            <span class="fa fa-fw fa-bar-chart"></span>&nbsp;
            SPI Graph
          </h3>
          <p>
            The SPI Graph tab allows a user to visualize, via bar charts over time, any item within the SPI View. This tab is very useful for both at a glance views of activity per SPI type,
            as well as deep dive analysis. As an example, if you wanted to chart all of the currently recorded http.users within your current time window, select http.user from the SPI Graph selection dropdown.
            Data will be displayed based upon count of observances over the time period. Increasing the Max Elements setting will allow an analyst to see additional items if the investigates SPI type is noisy.
          </p>

          <hr>

          <h3 id="connections">
            <span class="fa fa-fw fa-sitemap"></span>&nbsp;
            Connections
          </h3>
          <p>
            The Connections tab allows a user to view a tree force graph based on a source node and destination node of there choosing. Relationships may be visually determined using this method.
            An example of using this graph may be to set your Src node to ip.src, Dst node to ip.dst:port which will show the relationship of source IP addresses to destination IP address / port combinations.
            Those whom prefer to analyze session data view visualisation may heavily use these graphs. The default settings for this page may be set in the settings tab.
          </p>

          <hr>

          <h3 id="files">
            <span class="fa fa-fw fa-files-o"></span>&nbsp;
            Files
          </h3>
          <p>
            The files tab shows a table view of PCAPs which have been written. Details included are: File Number. Node, filename, if the file is locked, the first date and the file size.
          </p>

          <hr>

          <h3 id="stats">
            <span class="fa fa-fw fa-line-chart"></span>&nbsp;
            Stats
          </h3>
          <p>
            The Stats tab provides both a visual representation and table view of the metrics listed below, per node. Additional options for filtering may also be applied.  The stats are reported every 2 seconds.
            Options:
          </p>
          <dl class="dl-horizontal small">
            <dt>Packets/Sec</dt>
            <dd>The number of packets that we've received that aren't corrupt that we try to add to a packetQ per second</dd>
            <dt>Bytes/Sec</dt>
            <dd>The size of all the packets that we've received that aren't corrupt that we try add to a packetQ per second</dd>
            <dt>Bits/Sec</dt>
            <dd>Same as Bytes/Sec but in bits per second</dd>
            <dt>Sessions/Sec</dt>
            <dd>Number of sessions sent to elasticsearch per second</dd>
            <dt>Input Dropped/Sec</dt>
            <dd>Number of dropped packets as reported by the OS or network card (Moloch never sees these) per second</dd>
            <dt>Active Sessions</dt>
            <dd>Number of sessions Moloch is currently monitoring</dd>
            <dt>Active TCP Sessions</dt>
            <dd>Number of TCP sessions Moloch is currently monitoring</dd>
            <dt>Active UDP Sessions</dt>
            <dd>Number of UDP sessions Moloch is currently monitoring</dd>
            <dt>Active ICMP Sessions</dt>
            <dd>Number of ICMP sessions Moloch is currently monitoring</dd>
            <dt>Free Space MB</dt>
            <dd>Free space in MB across all configured disks</dd>
            <dt>Free Space %</dt>
            <dd>Percentage of free space across all configured disks</dd>
            <dt>Memory</dt>
            <dd>Amount of memory that Moloch is using</dd>
            <dt>Memory %</dt>
            <dd>Perentage of memory that Moloch is using</dd>
            <dt>CPU</dt>
            <dd>CPU percentage that Moloch is using</dd>
            <dt>Disk Queue</dt>
            <dd>Number of blocks of data that are waiting to be written to disk</dd>
            <dt>ES Queue</dt>
            <dd>Number of elasticsearch requests that are waiting to be sent</dd>
            <dt>ES Dropped/Sec</dt>
            <dd>Number of elasticsearch requests that were dropped because of queue overflow per second</dd>
            <dt>Packet Queue</dt>
            <dd>Number of packets that are waiting to processed</dd>
            <dt>Closing Queue</dt>
            <dd>Number of TCP sessions that have received a FIN and Moloch is waiting to see if actually closed</dd>
            <dt>Waiting Queue</dt>
            <dd>Number of sessions that are ready to be written but are waiting on an asynchronus request (wise, plugins) to finish</dd>
            <dt>Active Fragments</dt>
            <dd>Number of packets that are waiting on remaining IP fragments to show up</dd>
            <dt>Fragments Dropped/Sec</dt>
            <dd>Number of packets that were dropped because frag overload or timeouts</dd>
            <dt>Overload Dropped/Sec</dt>
            <dd>Number of packets dropped because there was no packet queue that was free to process them on</dd>
            <dt>Total Dropped/Sec</dt>
            <dd>Sum of the inputs dropped and overload metrics</dd>
          </dl>
          <hr>

          <h3 id="history">
            <span class="fa fa-fw fa-history"></span>&nbsp;
            History
          </h3>
          <p>
            The History tab provides the ability to view Moloch actions/queries to
            ES. It is usable both as a history for a user and for auditing abilities
            for an admin. A non-admin user can only view their own actions. An admin
            user can view all users' actions.
          </p>
          <div class="margined-left-xxxxlg">
            <span class="fa fa-fw fa-search"></span>&nbsp;
            Use the search input at the top of the page to search for specific history items.
            <br>
            <em style="margin-left:2.75rem;">
              Check out the ES
              <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-query-string-query.html#query-string-syntax">
                query string syntax</a>
              for more information about how to query the history table.
            </em>
          </div>
          <div class="margined-left-xxxxlg">
            <span class="fa fa-fw fa fa-clock-o"></span>&nbsp;
            Filter history by a time range by utilizing the time controls under the search bar.
          </div>
          <div class="margined-left-xxxxlg">
            <span class="fa fa-fw fa fa-sort"></span>&nbsp;
            Sort history by clicking any column header.
          </div>
          <div class="margined-left-xxxxlg">
            <span class="fa fa-fw fa-filter"></span>&nbsp;
            Use the filter button to filter history by specific field values.
          </div>
          <div class="margined-left-xxxxlg">
            <span class="fa fa-fw fa-check-square"></span>&nbsp;
            Use the checkboxes within column headers to display history items that
            always have a value for that field.
          </div>
          <div class="margined-left-xxxxlg">
            <span class="fa fa-fw fa-plus"></span>&nbsp;
            Use the expand button to display more information about a history item.
          </div>
          <div class="margined-left-xxxxlg">
            <span class="fa fa-fw fa-folder-open"></span>&nbsp;
            Use the open button to "go to" the history item. This will open the page
            that the action/query was issued from.
            <br>
            <em style="margin-left:2.5rem;">
              &nbsp;This is only available for the main GET requests from a page
              within the application.
            </em>
          </div>

          <hr>

          <h3 id="settings">
            <span class="fa fa-fw fa-cog"></span>&nbsp;
            Settings
          </h3>
          <p>
            The Settings tab allows for general user based settings to be managed. These settings include, timezone format, session detail format (such as ascii or hex), if timestamps should be displayed within session data,
            Which sessions column receives default sorting, the default graph for the SPI Graph tab, and the default Src field and Dst field for the Connections tab.
            Additionally, users may create views (saved queries) here as well. A user may also change their password on this page. If a user wishes to create a cron'd query
            they may add/remove these queries on this page as well.
          </p>

          <hr>

          <h3 id="users" v-has-permission="'createEnabled'">
            <span class="fa fa-fw fa-users"></span>&nbsp;
            Users
          </h3>
          <p v-has-permission="'createEnabled'">
            The Users tab, as you may have guessed, is where user options are configured and added to the system. Multiple options for role based access control (RBAC) may be leveraged.
            These options in include: The User ID, The Name of the user, a Forced expression (only allows a user to see data related to the specified expression/query), An Account enabled toggle, An Admin toggle,
            if the user is allowed access to the web interface, if the user is allowed access to http based Authorization Headers, if the user may search captured email data, if the user may remove data from the system (scrub).
            This page also allows for the deletion of a previously created user. Clicking on the Settings link will jump to the users Settings tab. (see above)
          </p>

          <hr v-has-permission="'createEnabled'">

          <h3 id="fields">
            <span class="fa fa-fw fa-list"></span>&nbsp;
            Fields
            <div class="input-group input-group-sm pull-right header-input">
              <div class="input-group-prepend">
                <span class="input-group-text">
                  <span class="fa fa-search">
                  </span>
                </span>
              </div>
              <input type="text"
                v-model="searchFields"
                class="form-control"
                placeholder="Search for fields in the table below"
              />
            </div>
            <button type="button"
              class="btn btn-secondary btn-checkbox btn-sm pull-right mr-1"
              :class="{'active':showDBFields}"
              @click="toggleDBFields">
              Display Database Fields
            </button>
          </h3>

          <table v-if="!error && fields"
            class="table table-sm table-striped">
            <thead>
              <tr>
                <th>
                  Name
                </th>
                <th>
                  Exp
                </th>
                <th v-if="showDBFields">
                  Database Field
                </th>
                <th>
                  Operators
                </th>
                <th>
                  Data Type
                </th>
                <th>
                  What?
                </th>
              </tr>
            </thead>
            <transition-group name="list"
              tag="tbody">
              <tr v-for="field in filteredFields"
                :key="field.exp">
                <td class="no-wrap">
                  {{ field.friendlyName }}
                </td>
                <td class="no-wrap">
                  {{ field.exp }}
                </td>
                <td class="no-wrap"
                  v-if="showDBFields">
                  {{ field.dbField }}
                </td>
                <td class="no-wrap">
                  {{ fieldOperator(field) }}
                </td>
                <td class="no-wrap">
                  {{ fieldType(field) }}
                </td>
                <td>
                  {{ field.help }}
                </td>
              </tr>
            </transition-group>
          </table>
          <div v-if="!filteredFields || !filteredFields.length"
            class="text-danger text-center">
            <span class="fa fa-warning">
            </span>&nbsp;
            No results match your search
          </div>
          <div v-if="error"
            class="alert alert-warning mt-3">
            <span class="fa fa-warning">
            </span>&nbsp;
            Error retrieving fields:
            {{ error }}
          </div>

        </div>

      </div>
    </div>
  </div> <!-- /help content -->

</template>

<script>
import FieldService from '../search/FieldService';

let timeout;
let info = {
  ip: { operator: '==, !=', type: 'ip' },
  lotermfield: { operator: '==, !=', type: 'lower case string' },
  termfield: { operator: '==, !=', type: 'mixed case string' },
  uptermfield: { operator: '==, !=', type: 'upper case string' },
  integer: { operator: '<, <=, ==, >=, >, !=', type: 'integer' },
  seconds: { operator: '<, <=, ==, >=, >, !=', type: 'date time' }
};

export default {
  name: 'Help',
  data: function () {
    return {
      error: '',
      fields: [],
      searchFields: '',
      showDBFields: false,
      filteredFields: []
    };
  },
  watch: {
    searchFields: function (newVal, oldVal) {
      this.debounceGetFilteredFields();
    }
  },
  created: function () {
    this.loadFields();
    this.debounceGetFilteredFields();
  },
  methods: {
    /* exposed page functions ------------------------------------ */
    debounceGetFilteredFields: function () {
      if (timeout) { clearTimeout(timeout); }
      // debounce the input so it only issues a request after keyups cease for 400ms
      timeout = setTimeout(() => {
        timeout = null;
        this.filteredFields = this.fields.filter((field) => {
          let hasMatch = field.exp.toLowerCase().includes(
            this.searchFields.toLowerCase()
          ) ||
          field.friendlyName.toLowerCase().includes(
            this.searchFields.toLowerCase()
          );

          if (this.showDBFields) {
            hasMatch = hasMatch ||
            field.dbField.toLowerCase().includes(
              this.searchFields.toLowerCase()
            );
          }

          return hasMatch;
        });
      }, 400);
    },
    toggleDBFields: function () {
      this.showDBFields = !this.showDBFields;
    },
    fieldOperator: function (field) {
      if (!info[field.type]) { return; }
      return info[field.type].operator;
    },
    fieldType: function (field) {
      if (!info[field.type]) { return; }
      return info[field.type].type;
    },
    /* helper functions ------------------------------------------ */
    loadFields: function () {
      FieldService.get(true)
        .then((response) => {
          this.fields = this.fixFields(response);
        }, (error) => {
          this.error = error;
        });
    },
    fixFields: function (fields) {
      fields.forEach((item) => {
        if (item.regex) {
          item.dbField = '';
        } else if (item.rawField) {
          item.dbField = item.dbField + ', ' + item.rawField;
        } else if (item.dbField === 'ipall') {
          item.dbField = '';
        }
      });

      return fields;
    }
  }
};
</script>

<style scoped>
/* make pre readable for dark and light themes */
.help-content pre {
  color: #333;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #ccc;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding-top: 16px;
}

/* help navigation */
.help-content div.nav-pills {
  min-width: 150px;
  border: 1px solid var(--color-gray);
  border-radius: 4px;
  position: sticky;
  top: 40px;
  height: calc(100vh - 50px);
  overflow-x: hidden;
  overflow-y: auto;
  white-space: nowrap;

  -webkit-box-shadow: 0 0 16px -2px black;
     -moz-box-shadow: 0 0 16px -2px black;
          box-shadow: 0 0 16px -2px black;
}

.help-content .nav-pills .nav-link {
  width: 100%;
}

.help-content div.nav-pills a {
  padding: 5px 8px !important;
}

.help-content div.nav-pills a.nested {
  margin-left: 2.4em;
  font-size: 0.85em;
  padding: 2px 5px !important;
}

.help-content .header-input {
  width: 70%;
}

/* field table animation */
.help-content .list-enter-active, .list-leave-active {
  transition: all .5s;
}
.help-content .list-enter, .list-leave-to {
  opacity: 0;
  transform: translateX(30px);
}
.help-content .list-move {
  transition: transform .5s;
}
</style>
